name: Deploy Microservices
on:
  push:
    branches:
      - master
env:
  AWS_REGION: us-west-2
  ECR_FRONTEND: personal-book-frontend
  ECR_BACKEND: personal-book-backend
  ECS_CLUSTER: personal-book-cluster
  SERVICE_FRONTEND: personal-book-frontend-service
  SERVICE_BACKEND: personal-book-backend-service

  TASK_DEF_BACKEND: personal-book-backend
  TASK_DEF_FRONTEND: personal-book-frontend
  CONTAINER_BACKEND: personal-book-backend-container
  CONTAINER_FRONTEND: personal-book-frontend-container

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    - id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    # --- Backend Build, Push, and Deploy ---
    - name: Build and Push Backend Docker Image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        cd server
        docker build -t $ECR_REGISTRY/$ECR_BACKEND:$IMAGE_TAG .
        docker push $ECR_REGISTRY/$ECR_BACKEND:$IMAGE_TAG

    # ðŸš€ REPLACED DEPLOYMENT STEP WITH CLI LOGIC
    - name: Deploy Backend (Dynamic Task Def Update)
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        FULL_IMAGE_URL: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_BACKEND }}:${{ github.sha }}
      run: |
        # 1. Fetch current Task Definition JSON
        TASK_DEF_JSON=$(aws ecs describe-task-definition --task-definition ${{ env.TASK_DEF_BACKEND }} --query taskDefinition --output json)

        # 2. Update the image tag in the JSON using jq (removes metadata, updates image)
        # Note: jq is pre-installed on ubuntu-latest runners
        NEW_TASK_DEF_JSON=$(echo "$TASK_DEF_JSON" | \
          jq --arg CONTAINER_NAME "${{ env.CONTAINER_BACKEND }}" \
             --arg NEW_IMAGE_URL "${{ env.FULL_IMAGE_URL }}" \
             '(.containerDefinitions[] | select(.name == $CONTAINER_NAME) | .image) = $NEW_IMAGE_URL |
              del(.status) | del(.taskDefinitionArn) | del(.revision) | del(.requiresAttributes) | del(.compatibilities) | del(.registeredAt) | del(.registeredBy)')

        # 3. Register a new Task Definition revision
        NEW_TASK_DEF_ARN=$(aws ecs register-task-definition --cli-input-json "$NEW_TASK_DEF_JSON" --query 'taskDefinition.taskDefinitionArn' --output text)

        # 4. Update the ECS service to use the new Task Definition
        aws ecs update-service --cluster ${{ env.ECS_CLUSTER }} --service ${{ env.SERVICE_BACKEND }} --task-definition "$NEW_TASK_DEF_ARN"

    # --- Frontend Build, Push, and Deploy ---
    - name: Build and Push Frontend Docker Image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        cd client
        docker build -t $ECR_REGISTRY/$ECR_FRONTEND:$IMAGE_TAG .
        docker push $ECR_REGISTRY/$ECR_FRONTEND:$IMAGE_TAG

    # ðŸš€ REPLACED DEPLOYMENT STEP WITH CLI LOGIC
    - name: Deploy Frontend (Dynamic Task Def Update)
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        FULL_IMAGE_URL: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_FRONTEND }}:${{ github.sha }}
      run: |
        # 1. Fetch current Task Definition JSON
        TASK_DEF_JSON=$(aws ecs describe-task-definition --task-definition ${{ env.TASK_DEF_FRONTEND }} --query taskDefinition --output json)

        # 2. Update the image tag in the JSON using jq (removes metadata, updates image)
        NEW_TASK_DEF_JSON=$(echo "$TASK_DEF_JSON" | \
          jq --arg CONTAINER_NAME "${{ env.CONTAINER_FRONTEND }}" \
             --arg NEW_IMAGE_URL "${{ env.FULL_IMAGE_URL }}" \
             '(.containerDefinitions[] | select(.name == $CONTAINER_NAME) | .image) = $NEW_IMAGE_URL |
              del(.status) | del(.taskDefinitionArn) | del(.revision) | del(.requiresAttributes) | del(.compatibilities) | del(.registeredAt) | del(.registeredBy)')

        # 3. Register a new Task Definition revision
        NEW_TASK_DEF_ARN=$(aws ecs register-task-definition --cli-input-json "$NEW_TASK_DEF_JSON" --query 'taskDefinition.taskDefinitionArn' --output text)

        # 4. Update the ECS service to use the new Task Definition
        aws ecs update-service --cluster ${{ env.ECS_CLUSTER }} --service ${{ env.SERVICE_FRONTEND }} --task-definition "$NEW_TASK_DEF_ARN"
